#!/usr/bin/perl
#Copyright 2010 Elliot Wolk
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
use strict;
use warnings;

my $configDir = '~/resolvconf/';

my $opt = shift;
$opt = '' if not defined $opt;

my @availableConfigs;
my $config;
for my $file(`ls -1 $configDir`){
  if($file =~ /^resolv.conf.([a-z]+)\n?$/i){
    push @availableConfigs, $1;
    if($opt eq $1){
      $config = 1;
      last;
    }
  }
}

if (not defined $opt or(
     $opt ne 'backup' and
     $opt ne 'restore' and
     $opt ne 'resolvconf' and
     not $config)){
  die "Usage $0 backup|restore|resolvconf|CONFIG
     {available configs=@availableConfigs}\n";
}


my $conf = '/etc/resolv.conf';
my $bak = '/etc/resolv.conf.bak';
my $real = '/etc/resolv.conf.real';
my $auto = '/etc/resolvconf/run/resolv.conf';

if($opt eq 'backup'){
  system "cp $real $bak";
}elsif($opt eq 'restore'){
  system "cp $bak $real";
}elsif($opt eq 'resolvconf'){
  system "rm $conf";
  system "ln -s $auto $conf";
}else{
  my $choice = $configDir . "resolv.conf.$opt";
  print "Applying $choice\n";
  system "cp $choice $real";

  system "rm $conf";
  system "ln -s $real $conf";
}

